name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-headers-test:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Test Security Headers
        run: |
          # Test CloudFront security headers configuration using curl
          echo "Testing security headers on production domains..."
          
          # Define expected headers (excluding COOP and COEP for Stripe/iframe compatibility)
          EXPECTED_HEADERS=(
            "Content-Security-Policy"
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Strict-Transport-Security"
            "Referrer-Policy"
            "Permissions-Policy"
          )
          
          # Test each domain (would need to be deployed first)
          DOMAINS=("askjds.com" "jdsimplified.com" "admin.jdsimplified.com")
          
          for domain in "${DOMAINS[@]}"; do
            echo "Testing headers for $domain"
            for header in "${EXPECTED_HEADERS[@]}"; do
              if curl -s -I "https://$domain" | grep -i "$header"; then
                echo "✅ $header found on $domain"
              else
                echo "❌ $header missing on $domain"
                exit 1
              fi
            done
          done
          
          # Note about intentionally omitted headers
          echo ""
          echo "ℹ️  Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy are intentionally omitted for Stripe.js/iframe compatibility"
          echo "✅ All required security headers validated successfully"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          # Fail on high and critical vulnerabilities
          npm audit --audit-level high
          
          # Generate detailed report
          npm audit --json > audit-report.json
          
          # Check for specific vulnerability types
          CRITICAL_COUNT=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_COUNT=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "❌ Security vulnerabilities found!"
            exit 1
          fi
          
          echo "✅ No critical or high vulnerabilities found"

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-report
          path: audit-report.json

  lighthouse-security:
    name: Lighthouse Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install -g @lhci/cli@0.12.x

      - name: Build application
        run: npm run build

      - name: Start SPA server with proper binding
        run: |
          # Start server with explicit binding to all interfaces for CI accessibility
          nohup npx serve -s dist -l tcp://0.0.0.0:4173 > server.log 2>&1 &
          
          # Health check loop to ensure server is ready
          echo "Waiting for server to be ready..."
          for i in {1..30}; do
            if curl -sSf http://localhost:4173/ > /dev/null 2>&1; then
              echo "✅ Server is ready on port 4173"
              break
            fi
            echo "Waiting for server... (attempt $i/30)"
            sleep 1
          done
          
          # Verify server is responding
          if ! curl -sSf http://localhost:4173/ > /dev/null 2>&1; then
            echo "❌ Server failed to start properly"
            cat server.log
            exit 1
          fi

      - name: Run Lighthouse CI
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          # Configure Lighthouse CI for security auditing
          cat > lighthouserc.cjs << EOF
          module.exports = {
            ci: {
              collect: {
                numberOfRuns: 1,
                settings: {
                  chromeFlags: '--no-sandbox --headless'
                }
              },
              assert: {
                assertions: {
                  'categories:performance': ['warn', {minScore: 0.6}],
                  'categories:accessibility': ['warn', {minScore: 0.8}],
                  'categories:best-practices': ['warn', {minScore: 0.8}]
                }
              },
              upload: {
                target: 'temporary-public-storage'
              }
            }
          };
          EOF
          
          # Run Lighthouse CI with explicit URLs for SPA routes
          lhci collect \
            --url=http://localhost:4173/ \
            --url=http://localhost:4173/chat \
            --url=http://localhost:4173/courses

  code-security-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Semgrep Security Scan
        uses: semgrep/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/react
            p/typescript
            p/secrets

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
        if: always()

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

# CSP validation removed - already covered by security-headers-test job

  edge-function-security:
    name: Edge Function Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate Edge Function Security
        run: |
          # Check for hardcoded secrets in Edge Functions
          if grep -r "sk_live\|sk_test\|whsec_" supabase/functions/ --exclude-dir=_shared; then
            echo "❌ Hardcoded secrets found in Edge Functions!"
            exit 1
          fi
          
          # Check for proper npm: specifiers (exclude test/debug functions)
          HTTPS_IMPORTS=$(grep -r "from ['\"]https://" supabase/functions/ | grep -v "npm:" | grep -v "jsr:" | grep -v "test" | grep -v "debug" || true)
          if [ -n "$HTTPS_IMPORTS" ]; then
            echo "❌ Non-npm/jsr imports found in Edge Functions!"
            echo "$HTTPS_IMPORTS"
            exit 1
          fi
          
          # Check for proper error handling in main functions (exclude test/debug functions)
          MAIN_FUNCTIONS=$(find supabase/functions -name "index.ts" | grep -v test | grep -v debug | grep -v minimal)
          FUNCTIONS_WITH_TRY_CATCH=0
          TOTAL_FUNCTIONS=0
          
          for func in $MAIN_FUNCTIONS; do
            TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + 1))
            if grep -q "try" "$func" && grep -q "catch" "$func"; then
              FUNCTIONS_WITH_TRY_CATCH=$((FUNCTIONS_WITH_TRY_CATCH + 1))
              echo "✅ $func has error handling"
            else
              echo "⚠️  $func missing error handling"
            fi
          done
          
          if [ $FUNCTIONS_WITH_TRY_CATCH -eq 0 ]; then
            echo "❌ No Edge Functions have proper error handling!"
            exit 1
          fi
          
          echo "✅ Found error handling in $FUNCTIONS_WITH_TRY_CATCH/$TOTAL_FUNCTIONS main Edge Functions"
          
          # Check for CORS headers in main functions
          FUNCTIONS_WITH_CORS=0
          for func in $MAIN_FUNCTIONS; do
            if grep -q "Access-Control-Allow-Origin" "$func"; then
              FUNCTIONS_WITH_CORS=$((FUNCTIONS_WITH_CORS + 1))
            fi
          done
          
          if [ $FUNCTIONS_WITH_CORS -eq 0 ]; then
            echo "❌ No Edge Functions have CORS headers!"
            exit 1
          fi
          
          echo "✅ Found CORS headers in $FUNCTIONS_WITH_CORS/$TOTAL_FUNCTIONS main Edge Functions"
          echo "✅ Edge Function security checks passed"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-headers-test, dependency-scan, lighthouse-security, code-security-scan, secret-scan, edge-function-security]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "# Security Audit Summary" > security-report.md
          echo "Date: $(date)" >> security-report.md
          echo "" >> security-report.md
          
          # Check job results
          JOBS=("security-headers-test" "dependency-scan" "lighthouse-security" "code-security-scan" "secret-scan" "edge-function-security")
          
          # Check individual job results
          if [ "${{ needs.security-headers-test.result }}" == "success" ]; then
            echo "✅ security-headers-test: PASSED" >> security-report.md
          else
            echo "❌ security-headers-test: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "✅ dependency-scan: PASSED" >> security-report.md
          else
            echo "❌ dependency-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.lighthouse-security.result }}" == "success" ]; then
            echo "✅ lighthouse-security: PASSED" >> security-report.md
          else
            echo "❌ lighthouse-security: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
            echo "✅ code-security-scan: PASSED" >> security-report.md
          else
            echo "❌ code-security-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "✅ secret-scan: PASSED" >> security-report.md
          else
            echo "❌ secret-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.edge-function-security.result }}" == "success" ]; then
            echo "✅ edge-function-security: PASSED" >> security-report.md
          else
            echo "❌ edge-function-security: FAILED" >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## Security Score" >> security-report.md
          
          # Calculate security score
          PASSED_COUNT=0
          if [ "${{ needs.security-headers-test.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.lighthouse-security.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.edge-function-security.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          
          SCORE=$((PASSED_COUNT * 100 / ${#JOBS[@]}))
          echo "Overall Security Score: $SCORE/100" >> security-report.md
          
          cat security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-report.md 