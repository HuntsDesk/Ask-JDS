name: ðŸ›¡ï¸ Security Audit & Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  security-headers-test:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Test Security Headers
        run: |
          # Test CloudFront security headers configuration using curl
          echo "Testing security headers on production domains..."
          
          # Define expected headers (excluding COOP, COEP, and Permissions-Policy for Stripe/iframe compatibility)
          EXPECTED_HEADERS=(
            "Content-Security-Policy"
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Strict-Transport-Security"
            "Referrer-Policy"
          )
          
          # Test each domain (would need to be deployed first)
          DOMAINS=("askjds.com" "jdsimplified.com" "admin.jdsimplified.com")
          
          for domain in "${DOMAINS[@]}"; do
            echo "Testing headers for $domain"
            for header in "${EXPECTED_HEADERS[@]}"; do
              if curl -s -I "https://$domain" | grep -i "$header"; then
                echo "âœ… $header found on $domain"
              else
                echo "âŒ $header missing on $domain"
                exit 1
              fi
            done
          done
          
          # Note about intentionally omitted headers
          echo ""
          echo "â„¹ï¸  Cross-Origin-Opener-Policy, Cross-Origin-Embedder-Policy, and Permissions-Policy are intentionally omitted for Stripe.js/iframe compatibility"
          echo "âœ… All required security headers validated successfully"

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          # Fail on high and critical vulnerabilities
          npm audit --audit-level high
          
          # Generate detailed report
          npm audit --json > audit-report.json
          
          # Check for specific vulnerability types
          CRITICAL_COUNT=$(cat audit-report.json | jq '.metadata.vulnerabilities.critical // 0')
          HIGH_COUNT=$(cat audit-report.json | jq '.metadata.vulnerabilities.high // 0')
          
          echo "Critical vulnerabilities: $CRITICAL_COUNT"
          echo "High vulnerabilities: $HIGH_COUNT"
          
          if [ "$CRITICAL_COUNT" -gt 0 ] || [ "$HIGH_COUNT" -gt 0 ]; then
            echo "âŒ Security vulnerabilities found!"
            exit 1
          fi
          
          echo "âœ… No critical or high vulnerabilities found"

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-report
          path: audit-report.json

  lighthouse-security:
    name: Lighthouse Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm ci
          npm install -g @lhci/cli@0.12.x

      - name: Build application
        run: npm run build

      - name: Verify build output
        run: |
          echo "=== Build Output Structure ==="
          ls -la dist/
          echo ""
          echo "=== Index.html content (first 20 lines) ==="
          head -20 dist/index.html || echo "No index.html found"
          echo ""
          echo "=== Static assets ==="
          find dist/ -name "*.js" -o -name "*.css" | head -10

      - name: Install Chrome
        uses: browser-actions/setup-chrome@latest

      - name: Start SPA server and verify
        run: |
          echo "Starting server on port 4173..."
          
          # Check what serve command is available
          echo "=== Checking serve command ==="
          npx serve --help || echo "serve help failed"
          
          # First try: Simple serve command without host binding
          echo "Attempting simple serve command..."
          nohup npx serve -s dist -l 4173 > server.log 2>&1 &
          SERVER_PID=$!
          echo "Server PID: $SERVER_PID"
          sleep 5
          
          # Check if process is running
          if kill -0 $SERVER_PID 2>/dev/null; then
            echo "âœ… serve process is running"
          else
            echo "âŒ serve process died, checking logs..."
            cat server.log
            
            # Try http-server as backup
            echo "Trying http-server instead..."
            npm install -g http-server
            nohup http-server dist -p 4173 --spa > server.log 2>&1 &
            SERVER_PID=$!
            sleep 5
          fi
          
          # Show server logs
          echo "=== Server Logs ==="
          cat server.log || echo "No server logs found"
          
          # Check port binding
          echo "=== Port Status ==="
          netstat -ln | grep :4173 || echo "Port 4173 not bound"
          
          # Test server with timeout
          echo "Testing server connectivity..."
          timeout 10s curl -v http://localhost:4173/ || echo "Server connection failed"
          
          # If server still not working, try Python server as last resort
          if ! curl -sSf http://localhost:4173/ > /dev/null 2>&1; then
            echo "All JavaScript servers failed, trying Python server..."
            pkill -f "serve\|http-server" || true
            cd dist
            nohup python3 -m http.server 4173 > ../server.log 2>&1 &
            SERVER_PID=$!
            cd ..
            sleep 3
            echo "Python server PID: $SERVER_PID"
          fi
          
          # Final connectivity test
          echo "=== Final Connectivity Test ==="
          for i in {1..10}; do
            if curl -sSf http://localhost:4173/ > /dev/null 2>&1; then
              echo "âœ… Server is responding on attempt $i"
              break
            fi
            echo "Attempt $i/10: Server not ready..."
            sleep 2
          done
          
          # Test routes
          echo "=== Testing Routes ==="
          curl -I http://localhost:4173/ 2>&1 | head -3
          curl -I http://localhost:4173/chat 2>&1 | head -3  
          curl -I http://localhost:4173/courses 2>&1 | head -3

      - name: Run Lighthouse CI with simplified approach
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
        run: |
          echo "Running simplified Lighthouse CI..."
          
          # Final server check
          if ! curl -sSf http://localhost:4173/ > /dev/null 2>&1; then
            echo "âŒ Server is not responding, cannot run Lighthouse"
            exit 1
          fi
          
          echo "âœ… Server is responding, starting Lighthouse..."
          
          # Run Lighthouse on homepage only first
          npx lhci collect \
            --url=http://localhost:4173/ \
            --settings.chromeFlags="--no-sandbox --headless --disable-gpu --disable-dev-shm-usage" \
            --settings.maxWaitForLoad=60000 \
            --verbose
          
          # Upload results (with fallback)
          npx @lhci/cli@0.12.x upload --target=temporary-public-storage || echo "Upload failed but audit completed successfully"

  code-security-scan:
    name: Code Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Semgrep Security Scan
        run: |
          pip install semgrep
          semgrep --config=p/security-audit --config=p/react --config=p/typescript --config=p/secrets --sarif --output=semgrep.sarif .
        continue-on-error: true

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: semgrep.sarif
        if: always()
        continue-on-error: true

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

# CSP validation removed - already covered by security-headers-test job

  edge-function-security:
    name: Edge Function Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate Edge Function Security
        run: |
          # Check for hardcoded secrets in Edge Functions
          if grep -r "sk_live\|sk_test\|whsec_" supabase/functions/ --exclude-dir=_shared; then
            echo "âŒ Hardcoded secrets found in Edge Functions!"
            exit 1
          fi
          
          # Check for proper npm: specifiers (exclude test/debug functions)
          HTTPS_IMPORTS=$(grep -r "from ['\"]https://" supabase/functions/ | grep -v "npm:" | grep -v "jsr:" | grep -v "test" | grep -v "debug" || true)
          if [ -n "$HTTPS_IMPORTS" ]; then
            echo "âŒ Non-npm/jsr imports found in Edge Functions!"
            echo "$HTTPS_IMPORTS"
            exit 1
          fi
          
          # Check for proper error handling in main functions (exclude test/debug functions)
          MAIN_FUNCTIONS=$(find supabase/functions -name "index.ts" | grep -v test | grep -v debug | grep -v minimal)
          FUNCTIONS_WITH_TRY_CATCH=0
          TOTAL_FUNCTIONS=0
          
          for func in $MAIN_FUNCTIONS; do
            TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + 1))
            if grep -q "try" "$func" && grep -q "catch" "$func"; then
              FUNCTIONS_WITH_TRY_CATCH=$((FUNCTIONS_WITH_TRY_CATCH + 1))
              echo "âœ… $func has error handling"
            else
              echo "âš ï¸  $func missing error handling"
            fi
          done
          
          if [ $FUNCTIONS_WITH_TRY_CATCH -eq 0 ]; then
            echo "âŒ No Edge Functions have proper error handling!"
            exit 1
          fi
          
          echo "âœ… Found error handling in $FUNCTIONS_WITH_TRY_CATCH/$TOTAL_FUNCTIONS main Edge Functions"
          
          # Check for CORS headers in main functions
          FUNCTIONS_WITH_CORS=0
          for func in $MAIN_FUNCTIONS; do
            if grep -q "Access-Control-Allow-Origin" "$func"; then
              FUNCTIONS_WITH_CORS=$((FUNCTIONS_WITH_CORS + 1))
            fi
          done
          
          if [ $FUNCTIONS_WITH_CORS -eq 0 ]; then
            echo "âŒ No Edge Functions have CORS headers!"
            exit 1
          fi
          
          echo "âœ… Found CORS headers in $FUNCTIONS_WITH_CORS/$TOTAL_FUNCTIONS main Edge Functions"
          echo "âœ… Edge Function security checks passed"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-headers-test, dependency-scan, lighthouse-security, code-security-scan, secret-scan, edge-function-security]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "# Security Audit Summary" > security-report.md
          echo "Date: $(date)" >> security-report.md
          echo "" >> security-report.md
          
          # Check job results
          JOBS=("security-headers-test" "dependency-scan" "lighthouse-security" "code-security-scan" "secret-scan" "edge-function-security")
          
          # Check individual job results
          if [ "${{ needs.security-headers-test.result }}" == "success" ]; then
            echo "âœ… security-headers-test: PASSED" >> security-report.md
          else
            echo "âŒ security-headers-test: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "âœ… dependency-scan: PASSED" >> security-report.md
          else
            echo "âŒ dependency-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.lighthouse-security.result }}" == "success" ]; then
            echo "âœ… lighthouse-security: PASSED" >> security-report.md
          else
            echo "âŒ lighthouse-security: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
            echo "âœ… code-security-scan: PASSED" >> security-report.md
          else
            echo "âŒ code-security-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "âœ… secret-scan: PASSED" >> security-report.md
          else
            echo "âŒ secret-scan: FAILED" >> security-report.md
          fi
          
          if [ "${{ needs.edge-function-security.result }}" == "success" ]; then
            echo "âœ… edge-function-security: PASSED" >> security-report.md
          else
            echo "âŒ edge-function-security: FAILED" >> security-report.md
          fi
          
          echo "" >> security-report.md
          echo "## Security Score" >> security-report.md
          
          # Calculate security score
          PASSED_COUNT=0
          if [ "${{ needs.security-headers-test.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.lighthouse-security.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.code-security-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          if [ "${{ needs.edge-function-security.result }}" == "success" ]; then
            PASSED_COUNT=$((PASSED_COUNT + 1))
          fi
          
          SCORE=$((PASSED_COUNT * 100 / ${#JOBS[@]}))
          echo "Overall Security Score: $SCORE/100" >> security-report.md
          
          cat security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit-report
          path: security-report.md 